<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Figure Generation Human Evaluation</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="data.js"></script>
    <style>
        body { font-family: 'Inter', sans-serif; background-color: #f3f4f6; }
        .hidden { display: none; }
        .image-container img { max-height: 500px; max-width: 100%; object-fit: contain; border: 1px solid #e5e7eb; }
        /* ë§í¬ ìŠ¤íƒ€ì¼ */
        a { color: #2563eb; text-decoration: none; }
        a:hover { text-decoration: underline; }
    </style>
</head>
<body class="text-gray-800">

    <div id="app" class="max-w-5xl mx-auto min-h-screen bg-white shadow-lg flex flex-col">
        
        <!-- HEADER -->
        <header class="bg-indigo-700 text-white p-6">
            <div class="flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold mb-2">ğŸ“„ Figure Generation Human Eval</h1>
                    <p class="text-indigo-100 text-sm mb-4 max-w-2xl">
                        ì‘ì„± ì˜ˆì •
                    </p>
                </div>
                <div class="text-right">
                    <button onclick="downloadResultsCSV()" class="bg-green-500 hover:bg-green-600 text-white px-5 py-3 rounded-lg font-bold shadow transition flex items-center gap-2">
                        <span>ğŸ“¥ ê²°ê³¼ íŒŒì¼ ë‹¤ìš´ë¡œë“œ (Excelìš©)</span>
                    </button>
                    <p class="text-xs text-indigo-200 mt-2">í‰ê°€ ì™„ë£Œ í›„ ë‹¤ìš´ë¡œë“œí•˜ì—¬ ì œì¶œí•´ì£¼ì„¸ìš”.</p>
                </div>
            </div>
            
            <div class="bg-indigo-800 p-4 rounded text-xs opacity-90 leading-relaxed mb-4">
                <strong>Abstract:</strong> 
                ì‘ì„± ì˜ˆì •
            </div>
            
            <div class="w-full bg-indigo-900 rounded-full h-4 relative overflow-hidden">
                <div id="progress-bar" class="bg-yellow-400 h-full transition-all duration-300" style="width: 0%"></div>
            </div>
            <div class="flex justify-between text-xs mt-1 text-indigo-200">
                <span>Progress</span>
                <span id="progress-text">0 / 120</span>
            </div>
        </header>

        <!-- VIEW 1: INDEX PAGE -->
        <div id="view-index" class="p-8 flex-1">
            <h2 class="text-xl font-bold mb-6 border-b pb-2">í‰ê°€ ëŒ€ìƒ ë…¼ë¬¸ ëª©ë¡ (120ê°œ)</h2>
            <div class="grid grid-cols-5 md:grid-cols-6 lg:grid-cols-8 gap-3" id="paper-grid">
                <!-- JS Generated -->
            </div>
        </div>

        <!-- VIEW 2: EVALUATION PAGE -->
        <div id="view-eval" class="hidden p-8 flex-1">
            <div class="flex justify-between items-center mb-6 sticky top-0 bg-white z-10 py-4 border-b">
                <button onclick="goHome()" class="text-gray-600 hover:text-indigo-800 font-bold flex items-center px-3 py-2 rounded hover:bg-gray-100">
                    â† ëª©ë¡ìœ¼ë¡œ
                </button>
                <div class="text-xl font-bold">Paper <span id="current-paper-id" class="text-indigo-600"></span> / 120</div>
                <div class="flex gap-2">
                    <button onclick="prevPaper()" class="px-4 py-2 bg-gray-200 rounded hover:bg-gray-300 font-medium">ì´ì „</button>
                    <button onclick="nextPaper()" class="px-4 py-2 bg-indigo-100 text-indigo-700 rounded hover:bg-indigo-200 font-medium">ë‹¤ìŒ (Skip)</button>
                </div>
            </div>

            <div class="bg-gray-50 p-5 rounded-lg mb-8 border border-gray-200">
                <h3 class="font-bold text-lg mb-2 text-gray-900" id="paper-title">Loading...</h3>
                <div class="flex gap-2 text-sm text-gray-500 mb-2">
                    <span class="font-mono bg-white border px-1 rounded">ID: <span id="folder-name"></span></span>
                </div>
                <a id="acl-link" href="#" target="_blank" class="inline-flex items-center gap-1 text-blue-600 hover:text-blue-800 font-medium transition">
                    ğŸ”— ACL Anthology ì›ë¬¸ ë³´ê¸°
                </a>
            </div>

            <div id="images-container" class="space-y-12 mb-12">
                <!-- Images Generated Here -->
            </div>

            <div class="bg-indigo-50 border border-indigo-100 p-6 rounded-lg shadow-sm">
                <h3 class="text-xl font-bold text-indigo-900 mb-6 border-b border-indigo-200 pb-2">ğŸ“Š Evaluation Metric</h3>
                <form id="eval-form">
                    
                    <div class="mb-8">
                        <label class="block font-bold text-lg mb-2">Q1. Text-Image Alignment (1-5)</label>
                        <p class="text-sm text-gray-600 mb-3">Does the image accurately reflect the caption?</p>
                        <div class="flex gap-6">
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q1" value="1" class="w-5 h-5 mb-1" required><span>1 (Bad)</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q1" value="2" class="w-5 h-5 mb-1"><span>2</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q1" value="3" class="w-5 h-5 mb-1"><span>3</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q1" value="4" class="w-5 h-5 mb-1"><span>4</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q1" value="5" class="w-5 h-5 mb-1"><span>5 (Good)</span></label>
                        </div>
                    </div>

                    <div class="mb-8">
                        <label class="block font-bold text-lg mb-2">Q2. Visual Quality (1-5)</label>
                        <p class="text-sm text-gray-600 mb-3">Is the image clear and high-quality?</p>
                        <div class="flex gap-6">
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q2" value="1" class="w-5 h-5 mb-1" required><span>1 (Bad)</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q2" value="2" class="w-5 h-5 mb-1"><span>2</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q2" value="3" class="w-5 h-5 mb-1"><span>3</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q2" value="4" class="w-5 h-5 mb-1"><span>4</span></label>
                            <label class="cursor-pointer flex flex-col items-center"><input type="radio" name="q2" value="5" class="w-5 h-5 mb-1"><span>5 (Good)</span></label>
                        </div>
                    </div>
                    
                    <!-- ì¶”ê°€ ì˜ê²¬ (ì„ íƒ) -->
                    <div class="mb-6">
                         <label class="block font-bold mb-2">Optional Comments</label>
                         <textarea name="comment" class="w-full p-2 border rounded" placeholder="íŠ¹ì´ì‚¬í•­ì´ ìˆë‹¤ë©´ ì ì–´ì£¼ì„¸ìš”..." rows="2"></textarea>
                    </div>

                    <div class="mt-8 text-right">
                        <button type="button" onclick="saveCurrentEval()" class="bg-indigo-600 hover:bg-indigo-700 text-white px-8 py-3 rounded-lg font-bold shadow-md transition transform hover:scale-105">
                            ì €ì¥ í›„ ë‹¤ìŒ (Save & Next) â†’
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script>
        let currentIndex = -1;
        // ë¸Œë¼ìš°ì € ë¡œì»¬ ì €ì¥ì†Œì—ì„œ ë°ì´í„° ë¶ˆëŸ¬ì˜¤ê¸°
        let evalResults = JSON.parse(localStorage.getItem('humanEvalResults_v2')) || {};

        window.onload = function() {
            if (!window.PAPER_DATA) {
                alert("ë°ì´í„° ë¡œë“œ ì‹¤íŒ¨: data.jsê°€ í•„ìš”í•©ë‹ˆë‹¤.");
                return;
            }
            renderIndex();
            updateProgress();
        };

        function showView(viewName) {
            document.getElementById('view-index').classList.add('hidden');
            document.getElementById('view-eval').classList.add('hidden');
            document.getElementById('view-' + viewName).classList.remove('hidden');
            window.scrollTo(0, 0);
        }

        function goHome() {
            renderIndex();
            showView('index');
        }

        function renderIndex() {
            const grid = document.getElementById('paper-grid');
            grid.innerHTML = '';

            window.PAPER_DATA.forEach((paper, idx) => {
                const btn = document.createElement('button');
                const isDone = evalResults[paper.folder_name];
                
                btn.className = `p-3 rounded-lg border text-center transition ${
                    isDone 
                    ? 'bg-green-50 border-green-400 text-green-700 shadow-sm' 
                    : 'bg-white border-gray-200 text-gray-500 hover:border-indigo-400 hover:text-indigo-600'
                }`;
                
                // ì™„ë£Œëœ í•­ëª©ì€ ì²´í¬ í‘œì‹œ
                const statusIcon = isDone ? 'âœ… ' : '';
                
                btn.innerHTML = `
                    <div class="text-base font-bold mb-1">${statusIcon}${idx + 1}</div>
                    <div class="text-xs opacity-70 overflow-hidden text-ellipsis whitespace-nowrap px-1" title="${paper.title}">
                        ${paper.title}
                    </div>
                `;
                btn.onclick = () => loadPaper(idx);
                grid.appendChild(btn);
            });
            updateProgress();
        }

        function loadPaper(index) {
            if (index < 0 || index >= window.PAPER_DATA.length) return;
            currentIndex = index;
            const paper = window.PAPER_DATA[index];

            document.getElementById('current-paper-id').innerText = index + 1;
            document.getElementById('paper-title').innerText = paper.title;
            document.getElementById('folder-name').innerText = paper.folder_name;
            
            const linkElem = document.getElementById('acl-link');
            if (paper.acl_id) {
                linkElem.href = `https://aclanthology.org/${paper.acl_id}/`;
                linkElem.classList.remove('hidden');
            } else {
                linkElem.href = `https://scholar.google.com/scholar?q=${encodeURIComponent(paper.title)}`;
            }

            const imgContainer = document.getElementById('images-container');
            imgContainer.innerHTML = '';
            
            if (paper.images.length === 0) {
                imgContainer.innerHTML = '<div class="text-center py-10 text-gray-400 bg-gray-50 rounded">ì´ë¯¸ì§€ê°€ ì—†ëŠ” ë…¼ë¬¸ì…ë‹ˆë‹¤.</div>';
            } else {
                paper.images.forEach(img => {
                    const wrapper = document.createElement('div');
                    wrapper.className = "flex flex-col bg-white p-4 rounded-xl shadow-sm border border-gray-100";
                    wrapper.innerHTML = `
                        <div class="w-full bg-gray-50 rounded-lg mb-4 flex justify-center image-container p-2">
                            <img src="${img.path}" alt="${img.filename}" loading="lazy" onerror="this.src='';this.alt='Image not found (check path)';">
                        </div>
                        <div class="bg-blue-50 p-4 rounded-lg border-l-4 border-blue-300">
                            <p class="text-xs font-bold text-blue-500 uppercase mb-1">Caption</p>
                            <p class="text-sm text-gray-800 leading-relaxed">${img.caption}</p>
                        </div>
                    `;
                    imgContainer.appendChild(wrapper);
                });
            }

            // í¼ ì´ˆê¸°í™” ë° ì´ì „ ë°ì´í„° ë¡œë“œ
            const form = document.getElementById('eval-form');
            form.reset();
            const prevData = evalResults[paper.folder_name];
            if (prevData) {
                Object.keys(prevData).forEach(key => {
                    if (form.elements[key]) {
                        form.elements[key].value = prevData[key];
                    }
                });
            }

            showView('eval');
        }

        function saveCurrentEval() {
            const paper = window.PAPER_DATA[currentIndex];
            const form = document.getElementById('eval-form');
            const formData = new FormData(form);
            const data = {};
            
            let hasAnswer = false;
            for (let [key, value] of formData.entries()) {
                data[key] = value;
                if(value) hasAnswer = true;
            }

            if (!hasAnswer) {
                if(!confirm("í‰ê°€ í•­ëª©ì´ ë¹„ì–´ìˆìŠµë‹ˆë‹¤. ê±´ë„ˆë›°ì‹œê² ìŠµë‹ˆê¹Œ?")) return;
            }

            // ê²°ê³¼ ì €ì¥
            evalResults[paper.folder_name] = data;
            // ë¡œì»¬ ìŠ¤í† ë¦¬ì§€ì— ì €ì¥ (ìƒˆë¡œê³ ì¹¨í•´ë„ ìœ ì§€ë¨)
            localStorage.setItem('humanEvalResults_v2', JSON.stringify(evalResults));

            if (currentIndex < window.PAPER_DATA.length - 1) {
                loadPaper(currentIndex + 1);
                window.scrollTo(0, 0);
            } else {
                alert("ëª¨ë“  ë…¼ë¬¸ì„ í™•ì¸í–ˆìŠµë‹ˆë‹¤! ë©”ì¸ í™”ë©´ìœ¼ë¡œ ëŒì•„ê°€ì„œ ê²°ê³¼ë¥¼ ë‹¤ìš´ë¡œë“œí•˜ì„¸ìš”.");
                goHome();
            }
        }

        function prevPaper() {
            if (currentIndex > 0) loadPaper(currentIndex - 1);
        }
        
        function nextPaper() {
            if (currentIndex < window.PAPER_DATA.length - 1) loadPaper(currentIndex + 1);
        }

        function updateProgress() {
            const total = window.PAPER_DATA.length;
            const done = Object.keys(evalResults).length;
            const percentage = Math.round((done / total) * 100);
            
            document.getElementById('progress-text').innerText = `${done} / ${total} (${percentage}%)`;
            document.getElementById('progress-bar').style.width = `${percentage}%`;
        }

        // CSV ë‹¤ìš´ë¡œë“œ ê¸°ëŠ¥ (Excelì—ì„œ ì—´ê¸° ì¢‹ìŒ)
        function downloadResultsCSV() {
            if (Object.keys(evalResults).length === 0) {
                alert("ì €ì¥ëœ í‰ê°€ ê²°ê³¼ê°€ ì—†ìŠµë‹ˆë‹¤.");
                return;
            }

            // CSV í—¤ë” ìƒì„±
            let csvContent = "\uFEFF"; // BOM (Excel í•œê¸€ ê¹¨ì§ ë°©ì§€)
            csvContent += "ID,Folder Name,Paper Title,Q1(Align),Q2(Quality),Comment\n";

            // ë°ì´í„° í–‰ ìƒì„±
            window.PAPER_DATA.forEach((paper, idx) => {
                const res = evalResults[paper.folder_name];
                if (res) {
                    // CSV í¬ë§·ì— ë§ê²Œ ì‰¼í‘œ ì²˜ë¦¬ ë“±
                    const cleanTitle = paper.title.replace(/,/g, " ");
                    const comment = res.comment ? res.comment.replace(/,/g, " ").replace(/\n/g, " ") : "";
                    
                    csvContent += `${idx + 1},${paper.folder_name},${cleanTitle},${res.q1 || ""},${res.q2 || ""},${comment}\n`;
                }
            });

            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            const link = document.createElement("a");
            link.setAttribute("href", url);
            link.setAttribute("download", "eval_results.csv");
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        }
    </script>
</body>
</html>